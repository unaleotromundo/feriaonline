<!-- Dentro del mismo puesto.html, reemplaza el bloque JS desde la línea donde carga el comerciante -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAlqGoYrHkASbhmE2aBKIOXqkkNBBEEiGU",
    authDomain: "feria-online-ec7c6.firebaseapp.com",
    projectId: "feria-online-ec7c6",
    storageBucket: "feria-online-ec7c6.appspot.com",
    messagingSenderId: "1001881267179",
    appId: "1:1001881267179:web:fc5ac0fd940964537887ae"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get("userId");
  const productoId = urlParams.get("productoId");

  if (!userId) {
    document.body.innerHTML = "<p class='text-center text-red-500'>Falta el ID del puesto.</p>";
    throw new Error("No se proporcionó userId en la URL");
  }

  let whatsappNumber = null;
  let nombreProducto = null;

  // Cargar productos primero para saber si hay uno seleccionado
  db.collectionGroup("productos")
    .where("userId", "==", userId)
    .get()
    .then(snapshot => {
      const productos = [];
      snapshot.forEach(doc => {
        productos.push({ id: doc.id, ...doc.data() });
      });

      let destacado = null;
      if (productoId) {
        destacado = productos.find(p => p.id === productoId);
        if (destacado) {
          nombreProducto = destacado.nombre || "este producto";
        }
      }

      // Mostrar producto destacado
      if (destacado) {
        document.getElementById("producto-destacado").innerHTML = `
          <div class="card-cmyk card-cyan">
            <h2 class="text-2xl font-bold mb-2">Producto destacado</h2>
            <img src="${destacado.imagen || 'https://via.placeholder.com/300'}" class="w-full h-48 object-cover rounded mb-2">
            <h3 class="text-xl font-bold">${destacado.nombre || 'Sin nombre'}</h3>
            <p>${destacado.descripcion || ''}</p>
            <p class="text-lg font-semibold mt-2">$${destacado.precio || '0.00'}</p>
          </div>
        `;
        productos.splice(productos.indexOf(destacado), 1);
      }

      // Mostrar lista de productos
      const grid = document.getElementById("productos-grid");
      productos.forEach(producto => {
        const card = document.createElement("div");
        card.className = "card-cmyk";
        card.innerHTML = `
          <img src="${producto.imagen || 'https://via.placeholder.com/300'}" class="w-full h-40 object-cover rounded mb-2">
          <h3 class="text-xl font-bold">${producto.nombre || 'Sin nombre'}</h3>
          <p>${producto.descripcion || ''}</p>
          <p class="text-lg font-semibold mt-2">$${producto.precio || '0.00'}</p>
        `;
        grid.appendChild(card);
      });
    });

  // Cargar datos del comerciante después
  db.collectionGroup("comerciantes")
    .where("userId", "==", userId)
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        whatsappNumber = data.whatsapp ? data.whatsapp.replace(/\D/g, "") : null;

        document.getElementById("puesto-info").innerHTML = `
          <img src="${data.logoUrl || 'https://via.placeholder.com/300'}" class="w-full h-40 object-cover rounded mb-2">
          <h1 class="text-3xl font-bold">${data.businessName || 'Puesto sin nombre'}</h1>
          <p>${data.description || ''}</p>
        `;

        // Botón de WhatsApp con mensaje personalizado
        if (whatsappNumber) {
          const whatsappBtn = document.getElementById("whatsapp-btn");
          let mensaje = "Hola, vi tu puesto en la feria online";
          if (nombreProducto) {
            mensaje += ` y me interesa "${nombreProducto}"`;
          }
          whatsappBtn.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(mensaje)}`;
          whatsappBtn.classList.remove("hidden");
        }
      }
    });
</script>
