<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Comerciantes - Feria Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 0;
        }
        .form-container {
            max-width: 500px;
            width: 95%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            @apply bg-white rounded-lg p-8 md:p-10;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200;
        }

        /* Estilos de botones 3D con CMYK */
        .btn-cmyk {
            @apply font-bold py-3 px-4 rounded-lg relative overflow-hidden text-lg;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }
        .btn-cmyk::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            background: rgba(0,0,0,0.1); /* Sombra sutil para efecto 3D */
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.2s ease;
            z-index: -1;
        }
        .btn-cmyk:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-cmyk:hover::after {
            transform: scaleY(1);
        }
        .btn-cmyk:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        
        /* Colores específicos CMYK para botones */
        .btn-cyan { @apply bg-cyan-500 text-white; }
        .btn-magenta { @apply bg-fuchsia-600 text-white; }
        .btn-yellow { @apply bg-yellow-400 text-gray-800; }
        .btn-black { @apply bg-gray-800 text-white; }

        .message-box {
            @apply p-4 rounded-md text-sm text-center;
        }
        .message-box.success { @apply bg-green-100 text-green-700; }
        .message-box.error { @apply bg-red-100 text-red-700; }
        .message-box.info { @apply bg-teal-100 text-teal-700; }

        /* Estilos para tooltips */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
            margin-bottom: 0.5rem;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0.25rem);
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
        }
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Loader para botones */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="form-container">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 text-center mb-8">
            Registro de Comerciante 🚀
        </h1>

        <div id="message-container" class="mb-6 hidden">
            <!-- Mensajes de éxito o error se mostrarán aquí -->
        </div>

        <form id="register-form" class="space-y-6">
            <div>
                <label for="businessName" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Negocio / Puesto:</label>
                <input type="text" id="businessName" name="businessName" placeholder="Ej: Artesanías El Sol" class="input-field" required>
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                <input type="email" id="email" name="email" placeholder="tu@email.com" class="input-field" required>
            </div>
            <div>
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                <input type="password" id="password" name="password" placeholder="Mínimo 6 caracteres" class="input-field" required minlength="6">
            </div>
            <div>
                <label for="whatsapp" class="block text-gray-700 text-sm font-bold mb-2">Número de WhatsApp (Opcional):</label>
                <input type="tel" id="whatsapp" name="whatsapp" placeholder="Ej: +54 9 11 1234 5678" class="input-field">
            </div>
            <div>
                <label for="description" class="block text-gray-700 text-sm font-bold mb-2">Describe tu Negocio (Opcional):</label>
                <textarea id="description" name="description" rows="3" class="input-field" placeholder="Qué vendes, tu historia, etc."></textarea>
            </div>
            <div>
                <label for="logoUrl" class="block text-gray-700 text-sm font-bold mb-2">URL del Logo de tu Puesto (Opcional):</label>
                <input type="url" id="logoUrl" name="logoUrl" placeholder="https://ejemplo.com/tu-logo.png" class="input-field">
                <p class="text-xs text-gray-500 mt-1">Sube el logo de tu negocio a un servicio de hosting y pega la URL aquí.</p>
            </div>

            <button type="submit" class="btn-cmyk btn-magenta w-full" data-tooltip="Crea tu nueva cuenta de comerciante">
                Registrar mi Puesto
            </button>
        </form>

        <p class="text-center text-gray-600 text-sm mt-6">
            ¿Ya tienes una cuenta? <a href="index.html" class="text-blue-600 hover:underline">Inicia Sesión aquí</a>
        </p>
    </div>

    <!-- Script para Firebase y lógica de registro -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { firebaseConfig, appId } from "./firebase-config.js";
        
        let app;
        let auth;
        let db;
        let userId = null; 

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = message;
            messageContainer.className = `message-box ${type}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                if (!app) {
                    console.log("Configuración de Firebase al inicializar:", firebaseConfig);
                    if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                        throw new Error("La configuración de Firebase es inválida o está vacía.");
                    }

                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Usuario autenticado:", userId);
                        } else {
                            userId = null;
                            console.log("Usuario no autenticado.");
                        }
                    });
                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage(`Error al iniciar la aplicación: ${error.message}`, 'error');
            }
        }

        window.onload = initializeFirebase;

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 

            const businessName = document.getElementById('businessName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const whatsapp = document.getElementById('whatsapp').value;
            const description = document.getElementById('description').value;
            const logoUrl = document.getElementById('logoUrl').value;

            if (password.length < 6) {
                showMessage('La contraseña debe tener al menos 6 caracteres.', 'error');
                return;
            }

            try {
                showMessage('Registrando tu puesto...', 'info');

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const newUserId = user.uid; 

                const comercianteDocRef = doc(db, `artifacts/${appId}/users/${newUserId}/comerciantes`, newUserId);
                
                await setDoc(comercianteDocRef, {
                    userId: newUserId,
                    businessName: businessName,
                    email: email,
                    whatsapp: whatsapp,
                    description: description,
                    logoUrl: logoUrl || 'https://placehold.co/150x150/cccccc/333333?text=Logo',
                    registrationDate: new Date()
                });

                showMessage('¡Tu puesto ha sido registrado con éxito! Redirigiendo al panel...', 'success');
                console.log("Comerciante registrado y datos guardados:", newUserId);

                setTimeout(() => {
                    window.location.href = 'panel-comerciante.html'; 
                }, 3000);

            } catch (error) {
                console.error("Error al registrar el comerciante:", error);
                let errorMessage = 'Hubo un error al registrar tu puesto. Por favor, intenta de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo electrónico ya está registrado. Intenta iniciar sesión.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'El formato del correo electrónico es inválido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña es demasiado débil. Necesita ser más robusta.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Problema de red. Verifica tu conexión a internet.';
                }
                showMessage(`Error: ${errorMessage}`, 'error');
            }
        });

    </script>
</body>
</html>
