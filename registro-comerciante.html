<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Comerciantes - Feria Online</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea al inicio para que el contenido no quede en medio de la nada */
            min-height: 100vh;
            padding: 2rem 0;
        }
        .form-container {
            max-width: 500px;
            width: 95%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200;
        }
        .submit-button {
            @apply w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-md transition-all duration-300 transform hover:scale-105;
        }
        .message-box {
            @apply p-4 rounded-md text-sm text-center;
        }
        .message-box.success {
            @apply bg-green-100 text-green-700;
        }
        .message-box.error {
            @apply bg-red-100 text-red-700;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="form-container bg-white rounded-lg p-8 md:p-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 text-center mb-8">
            Registro de Comerciante 🚀
        </h1>

        <div id="message-container" class="mb-6 hidden">
            <!-- Mensajes de éxito o error se mostrarán aquí -->
        </div>

        <form id="register-form" class="space-y-6">
            <div>
                <label for="businessName" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Negocio / Puesto:</label>
                <input type="text" id="businessName" name="businessName" placeholder="Ej: Artesanías El Sol" class="input-field" required>
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                <input type="email" id="email" name="email" placeholder="tu@email.com" class="input-field" required>
            </div>
            <div>
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                <input type="password" id="password" name="password" placeholder="Mínimo 6 caracteres" class="input-field" required minlength="6">
            </div>
            <div>
                <label for="whatsapp" class="block text-gray-700 text-sm font-bold mb-2">Número de WhatsApp (Opcional):</label>
                <input type="tel" id="whatsapp" name="whatsapp" placeholder="Ej: +54 9 11 1234 5678" class="input-field">
            </div>
            <div>
                <label for="description" class="block text-gray-700 text-sm font-bold mb-2">Describe tu Negocio (Opcional):</label>
                <textarea id="description" name="description" rows="3" class="input-field" placeholder="Qué vendes, tu historia, etc."></textarea>
            </div>

            <button type="submit" class="submit-button">
                Registrar mi Puesto
            </button>
        </form>

        <p class="text-center text-gray-600 text-sm mt-6">
            ¿Ya tienes una cuenta? <a href="#" id="login-link" class="text-blue-600 hover:underline font-semibold">Inicia Sesión aquí</a>
        </p>
    </div>

    <!-- Script para Firebase y lógica de registro -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Importamos la configuración de Firebase y el appId desde nuestro archivo local 'firebase-config.js'
        import { firebaseConfig, appId } from "./firebase-config.js";

        // Las variables __app_id, __firebase_config, __initial_auth_token no se usan en el entorno local
        // ya que la configuración se importa directamente de firebase-config.js.
        const initialAuthToken = null; // No necesario en esta configuración local

        let app;
        let auth;
        let db;
        let userId = null; // Para almacenar el ID del usuario autenticado

        // Función para mostrar mensajes al usuario
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = message;
            messageContainer.className = `message-box ${type}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden'); // Ocultar después de 5 segundos
            }, 5000);
        }

        // Función de inicialización de Firebase
        async function initializeFirebase() {
            try {
                // Si la app ya está inicializada, no la inicializamos de nuevo
                if (!app) {
                    // **VERIFICACIÓN IMPORTANTE:** Imprime la configuración de Firebase
                    console.log("Configuración de Firebase al inicializar:", firebaseConfig);

                    // Asegúrate de que firebaseConfig no esté vacío
                    if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                        throw new Error("La configuración de Firebase es inválida o está vacía.");
                    }

                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Escucha cambios en el estado de autenticación
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Usuario autenticado:", userId);
                        } else {
                            userId = null;
                            console.log("Usuario no autenticado.");
                        }
                    });

                    // Inicia sesión anónimamente para permitir el acceso a Firestore
                    // Esto permite que el código interactúe con la base de datos incluso si el usuario no se registra/loguea
                    // con email/password.
                    await signInAnonymously(auth);
                    console.warn("Autenticación anónima iniciada para permitir el uso de Firestore.");

                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage(`Error al iniciar la aplicación: ${error.message}`, 'error');
            }
        }

        // Llama a la inicialización cuando la ventana cargue
        window.onload = initializeFirebase;

        // Manejo del formulario de registro
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault(); // Previene el envío por defecto del formulario

            const businessName = document.getElementById('businessName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const whatsapp = document.getElementById('whatsapp').value;
            const description = document.getElementById('description').value;

            // Simple validación de contraseña
            if (password.length < 6) {
                showMessage('La contraseña debe tener al menos 6 caracteres.', 'error');
                return;
            }

            try {
                showMessage('Registrando tu puesto...', 'info');

                // 1. Crear usuario con Email y Contraseña en Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const newUserId = user.uid; // El ID único del usuario en Firebase Auth

                // 2. Guardar información adicional del comerciante en Cloud Firestore
                // Usamos el UID de Firebase Auth como ID del documento en Firestore
                // Ruta para datos privados del usuario: /artifacts/{appId}/users/{userId}/comerciantes/{documentId}
                const comercianteDocRef = doc(db, `artifacts/${appId}/users/${newUserId}/comerciantes`, newUserId);
                
                await setDoc(comercianteDocRef, {
                    userId: newUserId,
                    businessName: businessName,
                    email: email,
                    whatsapp: whatsapp,
                    description: description,
                    registrationDate: new Date()
                });

                showMessage('¡Tu puesto ha sido registrado con éxito! Redirigiendo al panel...', 'success');
                console.log("Comerciante registrado y datos guardados:", newUserId);

                // Redirigir al usuario a su panel de control después de un registro exitoso
                setTimeout(() => {
                    window.location.href = 'panel-comerciante.html'; 
                }, 3000); // Redirige después de 3 segundos

            } catch (error) {
                console.error("Error al registrar el comerciante:", error);
                let errorMessage = 'Hubo un error al registrar tu puesto. Por favor, intenta de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo electrónico ya está registrado. Intenta iniciar sesión.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'El formato del correo electrónico es inválido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña es demasiado débil. Necesita ser más robusta.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Problema de red. Verifica tu conexión a internet.';
                }
                showMessage(`Error: ${errorMessage}`, 'error');
            }
        });

        // Manejo del enlace de "Iniciar Sesión"
        // NOTA: Usar prompt() para credenciales NO es seguro ni una buena UX en producción.
        // Se recomienda implementar un modal o una página de inicio de sesión dedicada.
        document.getElementById('login-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Por favor, introduce tu email:");
            const password = prompt("Por favor, introduce tu contraseña:");

            if (email && password) {
                showMessage('Iniciando sesión...', 'info');
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        showMessage(`¡Bienvenido de nuevo, ${user.email}! Redirigiendo...`, 'success');
                        setTimeout(() => {
                            window.location.href = 'panel-comerciante.html';
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error("Error al iniciar sesión:", error);
                        let errorMessage = 'Error al iniciar sesión. Verifica tus credenciales.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            errorMessage = 'Correo o contraseña incorrectos.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'Formato de correo electrónico inválido.';
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = 'Problema de red. Verifica tu conexión a internet.';
                        }
                        showMessage(`Error: ${errorMessage}`, 'error');
                    });
            } else {
                showMessage('Inicio de sesión cancelado.', 'info');
            }
        });

    </script>
</body>
</html>
