<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Comerciante - Feria Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .product-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .submit-button-style {
            @apply w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105;
        }
        .message-box {
            @apply p-4 rounded-lg text-sm text-center font-medium;
        }
        .message-box.success { @apply bg-green-100 text-green-700; }
        .message-box.error { @apply bg-red-100 text-red-700; }
        .message-box.info { @apply bg-teal-100 text-teal-700; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">Mi Puesto Online</h1>
            <nav>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                    Cerrar Sesión
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-6 md:p-10">
        <div id="loading-container" class="text-center py-20 text-xl font-semibold text-gray-500">
            Cargando...
        </div>

        <div id="content" class="hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6" id="business-name-display"></h2>
            
            <div id="message-container" class="mb-6 hidden"></div>

            <!-- Sección para la información del puesto del comerciante -->
            <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Información de tu Puesto</h3>
                <div id="comerciante-details" class="space-y-3">
                    <p><strong class="font-semibold">Nombre del Negocio:</strong> <span id="detail-business-name"></span></p>
                    <p><strong class="font-semibold">Correo Electrónico:</strong> <span id="detail-email"></span></p>
                    <p><strong class="font-semibold">WhatsApp:</strong> <span id="detail-whatsapp"></span></p>
                    <p><strong class="font-semibold">Descripción:</strong> <span id="detail-description" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Logo URL:</strong> <span id="detail-logo-url" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Fecha de Registro:</strong> <span id="detail-registration-date"></span></p>
                    <!-- <button class="submit-button-style mt-4">Editar Información</button> -->
                </div>
            </section>

            <!-- Sección para añadir nuevo producto -->
            <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Añadir Nuevo Producto</h3>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="productName" name="productName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio</label>
                        <input type="number" id="productPrice" name="productPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" step="0.01" required>
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="productDescription" name="productDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                    </div>
                    <div>
                        <label for="productImage" class="block text-sm font-medium text-gray-700">Imagen (URL)</label>
                        <input type="url" id="productImage" name="productImage" placeholder="https://ejemplo.com/imagen.jpg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <button type="submit" class="submit-button-style">
                        Añadir Nuevo Producto
                    </button>
                </form>
            </section>

            <!-- Sección de productos del comerciante -->
            <section>
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Tus Productos Publicados</h3>
                <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas de productos se inyectarán aquí -->
                </div>
                <div id="no-products-message" class="text-center py-10 text-gray-500 hidden">
                    <p>Aún no tienes productos publicados.</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Script de Firebase y lógica del panel -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { firebaseConfig, appId } from "./firebase-config.js";

        let app;
        let auth;
        let db;
        let userId = null;
        let businessName = null;
        let unsubscribeComercianteData = null; // Listener para datos del comerciante
        let unsubscribeProducts = null; // Listener para productos

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = message;
            messageContainer.className = `message-box ${type}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                }

                onAuthStateChanged(auth, async (user) => {
                    const loadingContainer = document.getElementById('loading-container');
                    const contentContainer = document.getElementById('content');
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado:", userId);
                        
                        setupComercianteDataListener(userId);
                        setupProductsListener(userId);
                        
                        loadingContainer.classList.add('hidden');
                        contentContainer.classList.remove('hidden');

                    } else {
                        console.log("Usuario no autenticado, redirigiendo a registro.");
                        window.location.href = 'registro-comerciante.html';
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o cargar el panel:", error);
                showMessage(`Error al iniciar la aplicación: ${error.message}`, 'error');
            }
        }

        function setupComercianteDataListener(uid) {
            if (unsubscribeComercianteData) {
                unsubscribeComercianteData(); 
            }
            const comercianteDocRef = doc(db, `artifacts/${appId}/users/${uid}/comerciantes`, uid);
            unsubscribeComercianteData = onSnapshot(comercianteDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    businessName = data.businessName;
                    document.getElementById('business-name-display').textContent = businessName;
                    document.getElementById('detail-business-name').textContent = data.businessName || "No definido";
                    document.getElementById('detail-email').textContent = data.email || "No definido";
                    document.getElementById('detail-whatsapp').textContent = data.whatsapp || "No definido";
                    document.getElementById('detail-description').textContent = data.description || "Sin descripción.";
                    document.getElementById('detail-logo-url').textContent = data.logoUrl || "Sin URL de Logo";
                    
                    if (data.registrationDate && data.registrationDate.toDate) {
                        document.getElementById('detail-registration-date').textContent = data.registrationDate.toDate().toLocaleDateString('es-ES');
                    } else {
                        document.getElementById('detail-registration-date').textContent = "Fecha no disponible";
                    }
                    console.log("Datos del comerciante cargados/actualizados:", data);
                } else {
                    console.error("No se encontraron datos del comerciante para el usuario:", uid);
                    document.getElementById('business-name-display').textContent = 'Nombre del Negocio';
                    showMessage("No se encontró la información de tu puesto. Asegúrate de registrarte.", 'error');
                }
            }, (error) => {
                console.error("Error en el listener de datos del comerciante:", error);
                showMessage(`Error al cargar datos del negocio: ${error.message}`, 'error');
            });
        }

        function setupProductsListener(uid) {
            if (unsubscribeProducts) {
                unsubscribeProducts(); 
            }
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${uid}/productos`);
            unsubscribeProducts = onSnapshot(productsCollectionRef, (querySnapshot) => {
                const productsContainer = document.getElementById('products-container');
                const noProductsMessage = document.getElementById('no-products-message');
                productsContainer.innerHTML = ''; 

                if (querySnapshot.empty) {
                    noProductsMessage.classList.remove('hidden');
                    return;
                }
                
                noProductsMessage.classList.add('hidden');

                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    const cardHtml = `
                        <div class="bg-white rounded-lg product-card overflow-hidden">
                            <div class="h-48 overflow-hidden">
                                <img src="${product.imageUrl || 'https://placehold.co/400x250/cccccc/333333?text=Sin+Imagen'}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/333333?text=No+Disponible';">
                            </div>
                            <div class="p-4">
                                <h4 class="text-xl font-semibold text-gray-900">${product.name}</h4>
                                <p class="text-lg font-bold text-gray-800 mt-2">$${product.price ? product.price.toFixed(2) : '0.00'}</p>
                                <p class="text-sm text-gray-500 mt-1">${product.description || ''}</p>
                                <button data-id="${productId}" class="delete-button w-full mt-4 bg-red-500 hover:bg-red-600 text-white py-2 rounded-md transition-colors duration-200">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                    productsContainer.innerHTML += cardHtml;
                });

                productsContainer.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', deleteProduct);
                });
            }, (error) => {
                console.error("Error en el listener de productos:", error);
                showMessage(`Error al cargar tus productos: ${error.message}`, 'error');
            });
        }
        
        async function deleteProduct(e) {
            const productId = e.target.dataset.id;
            if (!userId || !productId) {
                showMessage("No se pudo eliminar el producto. Faltan datos del usuario o del producto.", 'error');
                return;
            }

            if (!confirm("¿Estás seguro de que quieres eliminar este producto?")) {
                return;
            }

            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/productos`, productId);
                await deleteDoc(productDocRef);
                showMessage('Producto eliminado con éxito.', 'success');
            } catch (error) {
                console.error("Error al eliminar el producto:", error);
                showMessage(`Error al eliminar el producto: ${error.message}`, 'error');
            }
        }

        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                showMessage("Debes iniciar sesión para añadir productos.", 'error');
                return;
            }

            const productName = document.getElementById('productName').value;
            const productPrice = parseFloat(document.getElementById('productPrice').value);
            const productDescription = document.getElementById('productDescription').value;
            const productImage = document.getElementById('productImage').value;

            try {
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/productos`);
                await addDoc(productsCollectionRef, {
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    imageUrl: productImage,
                    createdAt: new Date(),
                    comercianteId: userId,
                    businessName: businessName
                });

                showMessage('Producto añadido con éxito.', 'success');
                document.getElementById('add-product-form').reset(); 

            } catch (error) {
                console.error("Error al añadir el producto:", error);
                showMessage(`Error al añadir el producto: ${error.message}`, 'error');
            }
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                if (unsubscribeComercianteData) unsubscribeComercianteData();
                if (unsubscribeProducts) unsubscribeProducts();
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        });

        initializeFirebase();
    </script>
</body>
</html>
