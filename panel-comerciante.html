<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Comerciante - Feria Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column; /* Cambiado a columna para el footer */
            align-items: center;
            min-height: 100vh;
            padding: 2rem 0;
        }
        .panel-container {
            max-width: 900px;
            width: 95%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            @apply bg-white rounded-lg p-8 md:p-10; /* A√±adido bg-white y padding */
        }
        .section-card {
            @apply bg-white p-6 rounded-lg shadow-md mb-6;
        }
        /* Estilos de botones 3D con CMYK */
        .btn-cmyk {
            @apply font-bold py-2 px-4 rounded-lg relative overflow-hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }
        .btn-cmyk::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            background: rgba(0,0,0,0.1); /* Sombra sutil para efecto 3D */
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.2s ease;
            z-index: -1;
        }
        .btn-cmyk:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-cmyk:hover::after {
            transform: scaleY(1);
        }
        .btn-cmyk:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        
        /* Colores espec√≠ficos CMYK para botones */
        .btn-cyan { @apply bg-cyan-500 text-white; }
        .btn-magenta { @apply bg-fuchsia-600 text-white; }
        .btn-yellow { @apply bg-yellow-400 text-gray-800; }
        .btn-black { @apply bg-gray-800 text-white; }
        .btn-red { @apply bg-red-500 text-white; } /* Para cerrar sesi√≥n o eliminar */


        .message-box {
            @apply p-4 rounded-lg text-sm text-center font-medium;
        }
        .message-box.success { @apply bg-green-100 text-green-700; }
        .message-box.error { @apply bg-red-100 text-red-700; }
        .message-box.info { @apply bg-teal-100 text-teal-700; }

        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200;
        }
        .product-card {
            @apply bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm flex flex-col;
        }
        .product-card img {
            @apply w-full h-48 object-cover;
        }
        .product-card-content {
            @apply p-4 flex-grow;
        }
        .product-card-title {
            @apply text-lg font-semibold text-gray-900 mb-1;
        }
        .product-card-price {
            @apply text-xl font-bold text-green-600 mb-2;
        }
        .product-card-description {
            @apply text-gray-700 text-sm;
        }

        /* Estilos para tooltips */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
            margin-bottom: 0.5rem;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0.25rem);
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
        }
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Loader para botones */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="panel-container">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 mb-4 md:mb-0">
                Panel de <span id="business-name-display">Tu Puesto</span>
            </h1>
            <nav class="flex items-center space-x-4">
                <span id="user-id-display" class="bg-gray-200 text-gray-700 text-xs px-3 py-1 rounded-full hidden md:block"></span>
                <button id="go-to-gallery-button" class="btn-cmyk btn-yellow text-sm" data-tooltip="Explora la galer√≠a p√∫blica de productos y puestos">
                    Ver la Galer√≠a
                </button>
                <button id="logout-button" class="btn-cmyk btn-red text-sm" data-tooltip="Cierra tu sesi√≥n actual">
                    Cerrar Sesi√≥n
                </button>
            </nav>
        </header>

        <div id="message-container" class="mb-6 hidden">
            <!-- Mensajes se mostrar√°n aqu√≠ -->
        </div>

        <!-- Secci√≥n para CREAR la Informaci√≥n del Puesto (Visible solo si no existe) -->
        <section id="create-comerciante-section" class="section-card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Configura tu Puesto por Primera Vez üöÄ</h2>
            <p class="text-gray-700 mb-4">
                ¬°Bienvenido! Parece que a√∫n no tienes la informaci√≥n de tu puesto configurada. Por favor, completa los siguientes datos para comenzar a gestionar tu espacio en la feria.
            </p>
            <form id="create-comerciante-form" class="space-y-4">
                <div>
                    <label for="createBusinessName" class="block text-sm font-medium text-gray-700">Nombre del Negocio / Puesto:</label>
                    <input type="text" id="createBusinessName" name="createBusinessName" class="input-field" required placeholder="Ej: Artesan√≠as El Sol">
                </div>
                <div>
                    <label for="createWhatsapp" class="block text-sm font-medium text-gray-700">N√∫mero de WhatsApp (Opcional):</label>
                    <input type="tel" id="createWhatsapp" name="createWhatsapp" class="input-field" placeholder="Ej: +54 9 11 1234 5678">
                </div>
                <div>
                    <label for="createDescription" class="block text-sm font-medium text-gray-700">Describe tu Negocio (Opcional):</label>
                    <textarea id="createDescription" name="createDescription" rows="3" class="input-field" placeholder="Qu√© vendes, tu historia, etc."></textarea>
                </div>
                <div>
                    <label for="createLogoUrl" class="block text-sm font-medium text-gray-700">URL del Logo de tu Puesto (Opcional):</label>
                    <input type="url" id="createLogoUrl" name="createLogoUrl" class="input-field" placeholder="https://ejemplo.com/tu-logo.png">
                    <p class="text-xs text-gray-500 mt-1">Sube el logo de tu negocio a un servicio de hosting y pega la URL aqu√≠.</p>
                </div>
                <button type="submit" class="btn-cmyk btn-magenta w-full" data-tooltip="Guarda la informaci√≥n inicial de tu puesto para que sea visible en la feria">
                    Guardar Informaci√≥n del Puesto
                </button>
            </form>
        </section>

        <!-- Contenido principal del panel (oculto hasta que el puesto est√© configurado) -->
        <div id="main-panel-content" class="hidden">
            <!-- Secci√≥n de Informaci√≥n del Puesto (existente, para ver y editar) -->
            <section class="section-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Informaci√≥n de tu Puesto üìã</h2>
                <div id="loading-spinner" class="text-center text-gray-500 hidden">
                    Cargando informaci√≥n del puesto...
                </div>
                <div id="comerciante-details" class="space-y-3">
                    <p><strong class="font-semibold">Nombre del Negocio:</strong> <span id="detail-business-name"></span></p>
                    <p><strong class="font-semibold">Correo Electr√≥nico:</strong> <span id="detail-email"></span></p>
                    <p><strong class="font-semibold">WhatsApp:</strong> <span id="detail-whatsapp"></span></p>
                    <p><strong class="font-semibold">Descripci√≥n:</strong> <span id="detail-description" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Logo URL:</strong> <span id="detail-logo-url" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Fecha de Registro:</strong> <span id="detail-registration-date"></span></p>
                    <button id="edit-comerciante-button" class="btn-cmyk btn-yellow mt-4" data-tooltip="Modifica los detalles de tu negocio y la URL de tu logo">Editar Informaci√≥n</button>
                </div>

                <!-- Formulario de Edici√≥n del Puesto (Inicialmente oculto) -->
                <div id="edit-comerciante-form-container" class="hidden mt-6 bg-gray-50 p-6 rounded-lg">
                    <h4 class="text-xl font-bold text-gray-700 mb-4">Editar Datos del Puesto</h4>
                    <form id="comerciante-edit-form" class="space-y-4">
                        <div>
                            <label for="editBusinessName" class="block text-sm font-medium text-gray-700">Nombre del Negocio</label>
                            <input type="text" id="editBusinessName" name="editBusinessName" class="input-field" required>
                        </div>
                        <div>
                            <label for="editEmail" class="block text-sm font-medium text-gray-700">Correo Electr√≥nico</label>
                            <input type="email" id="editEmail" name="editEmail" class="input-field" readonly disabled>
                            <p class="text-xs text-gray-500 mt-1">El correo electr√≥nico no se puede cambiar aqu√≠.</p>
                        </div>
                        <div>
                            <label for="editWhatsapp" class="block text-sm font-medium text-gray-700">N√∫mero de WhatsApp</label>
                            <input type="tel" id="editWhatsapp" name="editWhatsapp" class="input-field">
                        </div>
                        <div>
                            <label for="editDescription" class="block text-sm font-medium text-gray-700">Descripci√≥n del Negocio</label>
                            <textarea id="editDescription" name="editDescription" rows="3" class="input-field"></textarea>
                        </div>
                        <div>
                            <label for="editLogoUrl" class="block text-sm font-medium text-gray-700">URL del Logo de tu Puesto</label>
                            <input type="url" id="editLogoUrl" name="editLogoUrl" class="input-field">
                            <p class="text-xs text-gray-500 mt-1">Sube el logo de tu negocio a un servicio de hosting y pega la URL aqu√≠.</p>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="cancel-edit-comerciante" class="btn-cmyk btn-black text-sm" data-tooltip="Descartar los cambios y volver a la vista de los datos del puesto">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-cmyk btn-cyan text-sm" data-tooltip="Guarda las modificaciones realizadas en la informaci√≥n de tu puesto">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Secci√≥n de Gesti√≥n de Productos -->
            <section class="section-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Gesti√≥n de Productos üì¶</h2>
                <p class="text-gray-700 mb-4">
                    Aqu√≠ podr√°s armar y organizar el cat√°logo de tus productos, subir im√°genes, definir precios y descripciones.
                </p>
                
                <button id="toggle-add-product-form" class="btn-cmyk btn-cyan mb-4" data-tooltip="Muestra u oculta el formulario para a√±adir un nuevo producto">A√±adir Nuevo Producto</button>

                <!-- Formulario para A√±adir Nuevo Producto (inicialmente oculto) -->
                <div id="add-product-form-container" class="bg-blue-50 p-6 rounded-lg mb-6 hidden">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">A√±adir Nuevo Producto</h3>
                    <form id="product-form" class="space-y-4">
                        <div>
                            <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Producto:</label>
                            <input type="text" id="product-name" class="input-field" required placeholder="Nombre del producto">
                        </div>
                        <div>
                            <label for="product-price" class="block text-gray-700 text-sm font-bold mb-2">Precio:</label>
                            <input type="number" id="product-price" class="input-field" step="0.01" min="0" required placeholder="Ej: 29.99">
                        </div>
                        <div>
                            <label for="product-image-url" class="block text-gray-700 text-sm font-bold mb-2">URL de la Imagen del Producto:</label>
                            <input type="url" id="product-image-url" class="input-field" placeholder="https://ejemplo.com/imagen.jpg">
                            <p class="text-xs text-gray-500 mt-1">Sube la imagen a un servicio de hosting de im√°genes y pega la URL aqu√≠.</p>
                        </div>
                        <div>
                            <label for="product-description" class="block text-gray-700 text-sm font-bold mb-2">Descripci√≥n del Producto:</label>
                            <textarea id="product-description" rows="4" class="input-field" placeholder="Describe tu producto..."></textarea>
                        </div>
                        <button type="submit" class="btn-cmyk btn-magenta w-full flex items-center justify-center" data-tooltip="Guarda este producto en tu cat√°logo y publ√≠calo en la feria">
                            <span id="add-product-loading-spinner" class="loader hidden"></span>
                            Guardar Producto
                        </button>
                    </form>
                </div>

                <!-- Lista de Productos -->
                <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Tus Productos Publicados</h3>
                <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="no-products-message" class="col-span-full text-center text-gray-500 hidden">
                        A√∫n no tienes productos. ¬°A√±ade el primero!
                    </p>
                    <!-- Las tarjetas de productos se inyectar√°n aqu√≠ -->
                </div>

                <hr class="my-6 border-gray-200">

                <!-- Nueva Secci√≥n: Generador de Descripci√≥n de Producto ‚ú® -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    Generador de Descripci√≥n de Producto ‚ú®
                </h3>
                <p class="text-gray-700 mb-4">
                    Usa la inteligencia artificial para crear descripciones atractivas para tus productos.
                </p>
                <div class="space-y-4">
                    <div>
                        <label for="product-keywords" class="block text-gray-700 text-sm font-bold mb-2">
                            Palabras clave o nombre del producto (ej: "collar de plata artesanal, dise√±o √∫nico")
                        </label>
                        <input type="text" id="product-keywords" class="input-field" placeholder="Ingresa palabras clave sobre tu producto">
                    </div>
                    <div>
                        <label for="generated-description" class="block text-gray-700 text-sm font-bold mb-2">
                            Descripci√≥n Generada:
                        </label>
                        <textarea id="generated-description" rows="6" class="input-field" placeholder="Tu descripci√≥n aparecer√° aqu√≠..." readonly></textarea>
                    </div>
                    <button id="generate-description-button" class="btn-cmyk btn-cyan flex items-center justify-center" data-tooltip="Usa IA para crear una descripci√≥n para tu producto a partir de palabras clave">
                        <span id="generate-loading-spinner" class="loader hidden"></span>
                        Generar Descripci√≥n
                    </button>
                </div>
            </section>

            <!-- Secci√≥n de Promociones (Placeholder) -->
            <section class="section-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tus Promociones ‚ú®</h2>
                <p class="text-gray-700 mb-4">
                    Crea y gestiona tus ofertas especiales y descuentos para atraer m√°s clientes. (Funcionalidad futura)
                </p>
                <button class="btn-cmyk btn-black" data-tooltip="Pr√≥ximamente: crea y gestiona tus promociones especiales">Crear Nueva Promoci√≥n</button>
            </section>
        </div>
    </div>

    <!-- Pie de p√°gina -->
    <footer class="text-center text-gray-500 text-sm mt-8 pt-6 border-t border-gray-200">
        &copy; 2025 Feria Online. Panel del Comerciante.
    </footer>

    <!-- Script para Firebase y l√≥gica del panel -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { firebaseConfig, appId } from "./firebase-config.js";

        let app;
        let auth;
        let db;
        let userId = null;
        let businessName = null;
        let unsubscribeComercianteData = null;
        let unsubscribeProducts = null;

        // Elementos del DOM del Panel Principal
        const messageContainer = document.getElementById('message-container');
        const businessNameDisplay = document.getElementById('business-name-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const comercianteDetails = document.getElementById('comerciante-details');
        const mainPanelContent = document.getElementById('main-panel-content'); // Nuevo contenedor para el contenido principal

        const detailBusinessName = document.getElementById('detail-business-name');
        const detailEmail = document.getElementById('detail-email');
        const detailWhatsapp = document.getElementById('detail-whatsapp');
        const detailDescription = document.getElementById('detail-description');
        const detailLogoUrl = document.getElementById('detail-logo-url'); // A√±adido para mostrar logoUrl
        const detailRegistrationDate = document.getElementById('detail-registration-date');
        const logoutButton = document.getElementById('logout-button');
        const goToGalleryButton = document.getElementById('go-to-gallery-button');

        // Elementos para el Formulario de Creaci√≥n de Puesto
        const createComercianteSection = document.getElementById('create-comerciante-section');
        const createComercianteForm = document.getElementById('create-comerciante-form');
        const createBusinessNameInput = document.getElementById('createBusinessName');
        const createWhatsappInput = document.getElementById('createWhatsapp');
        const createDescriptionInput = document.getElementById('createDescription');
        const createLogoUrlInput = document.getElementById('createLogoUrl');

        // Elementos para el Formulario de Edici√≥n de Puesto
        const editComercianteButton = document.getElementById('edit-comerciante-button');
        const editComercianteFormContainer = document.getElementById('edit-comerciante-form-container');
        const comercianteEditForm = document.getElementById('comerciante-edit-form');
        const editBusinessName = document.getElementById('editBusinessName');
        const editEmail = document.getElementById('editEmail');
        const editWhatsapp = document.getElementById('editWhatsapp');
        const editDescription = document.getElementById('editDescription');
        const editLogoUrl = document.getElementById('editLogoUrl');
        const cancelEditComercianteButton = document.getElementById('cancel-edit-comerciante');


        // Elementos del Generador de Descripci√≥n
        const productKeywordsInput = document.getElementById('product-keywords');
        const generatedDescriptionTextarea = document.getElementById('generated-description');
        const generateDescriptionButton = document.getElementById('generate-description-button');
        const generateLoadingSpinner = document.getElementById('generate-loading-spinner');

        // Elementos del Editor de Productos
        const toggleAddProductFormButton = document.getElementById('toggle-add-product-form');
        const addProductFormContainer = document.getElementById('add-product-form-container');
        const productForm = document.getElementById('product-form');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const productImageUrlInput = document.getElementById('product-image-url');
        const productDescriptionInput = document.getElementById('product-description');
        const addProductLoadingSpinner = document.getElementById('add-product-loading-spinner');
        const productsList = document.getElementById('products-list');
        const noProductsMessage = document.getElementById('no-products-message');


        // Funci√≥n para mostrar mensajes al usuario
        function showMessage(message, type = 'info') {
            messageContainer.innerHTML = message;
            messageContainer.className = `message-box ${type}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
            }, 5000);
        }

        // Funci√≥n para cargar los datos del comerciante
        async function loadComercianteData(currentUserId) {
            if (!db || !currentUserId) {
                console.warn("Firestore no inicializado o userId no disponible.");
                return;
            }

            // Oculta el contenido principal y muestra el spinner de carga al inicio.
            // Esto asegura que el usuario no vea contenido roto si el documento no existe a√∫n.
            mainPanelContent.classList.add('hidden');
            createComercianteSection.classList.add('hidden'); // Ocultar tambi√©n la secci√≥n de creaci√≥n
            loadingSpinner.classList.remove('hidden');

            // Ruta del documento del comerciante: /artifacts/{appId}/users/{userId}/comerciantes/{userId}
            const comercianteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/comerciantes`, currentUserId);

            // Escuchar cambios en tiempo real con onSnapshot
            unsubscribeComercianteData = onSnapshot(comercianteDocRef, (docSnap) => {
                loadingSpinner.classList.add('hidden'); // Siempre ocultar spinner una vez que el estado de los datos es conocido.

                if (docSnap.exists()) {
                    // Si el documento existe, muestra los detalles y el contenido principal del panel.
                    createComercianteSection.classList.add('hidden'); // Asegura que el formulario de creaci√≥n est√© oculto
                    mainPanelContent.classList.remove('hidden'); // Muestra el contenido principal

                    const data = docSnap.data();
                    businessName = data.businessName; // Guarda el nombre del negocio
                    businessNameDisplay.textContent = businessName || "Tu Puesto";
                    detailBusinessName.textContent = data.businessName || "No definido";
                    detailEmail.textContent = data.email || "No definido";
                    detailWhatsapp.textContent = data.whatsapp || "No definido";
                    detailDescription.textContent = data.description || "Sin descripci√≥n.";
                    detailLogoUrl.textContent = data.logoUrl || "Sin URL de Logo";
                    
                    if (data.registrationDate && data.registrationDate.toDate) {
                        detailRegistrationDate.textContent = data.registrationDate.toDate().toLocaleDateString('es-ES');
                    } else {
                        detailRegistrationDate.textContent = "Fecha no disponible";
                    }

                    userIdDisplay.textContent = `ID de Usuario: ${currentUserId}`; // Mostrar el userId completo
                    userIdDisplay.classList.remove('hidden');

                    comercianteDetails.classList.remove('hidden'); // Asegura que los detalles del puesto sean visibles
                    loadProducts(currentUserId); // Cargar productos una vez que los datos del comerciante est√©n disponibles

                } else {
                    // Si el documento NO existe, muestra el formulario de creaci√≥n de puesto.
                    console.log("No se encontraron datos para este comerciante. Mostrando formulario de creaci√≥n.");
                    businessNameDisplay.textContent = "Configura tu Puesto"; // Actualiza el encabezado para la fase de configuraci√≥n
                    mainPanelContent.classList.add('hidden'); // Oculta el contenido principal del panel
                    createComercianteSection.classList.remove('hidden'); // Muestra el formulario de creaci√≥n
                    showMessage('¬°Bienvenido! Parece que es tu primera vez. Por favor, configura tu puesto.', 'info');

                    // Pre-rellenar email si el usuario ya est√° autenticado (aunque sea an√≥nimamente)
                    if (auth.currentUser && auth.currentUser.email) {
                        editEmail.value = auth.currentUser.email; // Usar el campo de edici√≥n para pre-rellenar
                    }
                }
            }, (error) => {
                console.error("Error al obtener datos del comerciante en tiempo real:", error);
                loadingSpinner.classList.add('hidden');
                showMessage(`Error al cargar la informaci√≥n del puesto: ${error.message}`, 'error');
                // En caso de error, tambi√©n mostramos el formulario de creaci√≥n por si el problema no era de permisos.
                mainPanelContent.classList.add('hidden');
                createComercianteSection.classList.remove('hidden');
            });
        }

        // Funci√≥n de inicializaci√≥n de Firebase
        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Escucha cambios en el estado de autenticaci√≥n.
                    // Esto se dispara cuando un usuario inicia sesi√≥n, cierra sesi√≥n o se registra.
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Usuario autenticado en el panel:", userId);
                            loadComercianteData(userId); // Cargar datos del comerciante
                        } else {
                            userId = null;
                            console.log("No hay usuario autenticado. Redirigiendo a la p√°gina principal.");
                            showMessage('No has iniciado sesi√≥n. Redirigiendo...', 'info');
                            setTimeout(() => {
                                window.location.href = 'index.html'; 
                            }, 2000); // Redirige despu√©s de 2 segundos
                        }
                    });

                    // Inicia sesi√≥n an√≥nimamente si no hay un usuario autenticado.
                    // Esto es crucial para que Firestore pueda intentar leer documentos,
                    // incluso si el usuario no se ha logueado con email/password.
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                        console.warn("Autenticaci√≥n an√≥nima iniciada para permitir el uso de Firestore y comprobar el estado de autenticaci√≥n.");
                    }
                    
                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage(`Error al iniciar la aplicaci√≥n: ${error.message}`, 'error');
            }
        }

        // --- L√≥gica del Generador de Descripci√≥n de Producto (API de Gemini) ---

        async function generateProductDescription() {
            const keywords = productKeywordsInput.value.trim();
            if (!keywords) {
                showMessage('Por favor, ingresa palabras clave o el nombre del producto.', 'error');
                return;
            }

            generatedDescriptionTextarea.value = ''; // Limpiar textarea
            generateLoadingSpinner.classList.remove('hidden'); // Mostrar spinner
            generateDescriptionButton.disabled = true; // Desactivar bot√≥n

            const prompt = `Genera una descripci√≥n de producto atractiva y persuasiva para un comercio online, bas√°ndote en las siguientes palabras clave: "${keywords}". Incluye detalles sobre sus caracter√≠sticas, beneficios y el valor que aporta al cliente. S√© conciso pero completo.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // La API key ser√° proporcionada por Canvas en runtime

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    generatedDescriptionTextarea.value = text;
                    showMessage('Descripci√≥n generada con √©xito. ¬°No olvides revisarla y adaptarla!', 'success');
                } else {
                    showMessage('No se pudo generar la descripci√≥n. Intenta con otras palabras clave.', 'error');
                    console.error("Respuesta inesperada de Gemini API:", result);
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                showMessage(`Error al generar la descripci√≥n: ${error.message}.`, 'error');
            } finally {
                generateLoadingSpinner.classList.add('hidden'); // Ocultar spinner
                generateDescriptionButton.disabled = false; // Habilitar bot√≥n
            }
        }

        generateDescriptionButton.addEventListener('click', generateProductDescription);

        // --- Fin de la L√≥gica del Generador de Descripci√≥n ---

        // --- L√≥gica del Formulario de Creaci√≥n de Puesto (Si no existe el documento) ---
        createComercianteForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessage("No est√°s autenticado. Por favor, inicia sesi√≥n para crear tu puesto.", 'error');
                return;
            }

            const businessName = createBusinessNameInput.value.trim();
            const whatsapp = createWhatsappInput.value.trim();
            const description = createDescriptionInput.value.trim();
            const logoUrl = createLogoUrlInput.value.trim();

            if (!businessName) {
                showMessage("El nombre del negocio es obligatorio para crear tu puesto.", 'error');
                return;
            }

            showMessage('Guardando la informaci√≥n de tu puesto...', 'info');
            const submitButton = createComercianteForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                const comercianteDocRef = doc(db, `artifacts/${appId}/users/${userId}/comerciantes`, userId);
                
                // Usamos setDoc aqu√≠ porque estamos creando el documento inicial del puesto
                await setDoc(comercianteDocRef, {
                    userId: userId,
                    businessName: businessName,
                    email: auth.currentUser.email, // Tomamos el email del usuario autenticado
                    whatsapp: whatsapp,
                    description: description,
                    logoUrl: logoUrl || 'https://placehold.co/150x150/cccccc/333333?text=Logo',
                    registrationDate: new Date()
                });

                showMessage('¬°Informaci√≥n del puesto guardada con √©xito! Ya puedes a√±adir productos. üéâ', 'success');
                // El onSnapshot en loadComercianteData detectar√° el nuevo documento y actualizar√° la vista.
                createComercianteForm.reset(); // Limpiar el formulario de creaci√≥n
                
            } catch (error) {
                console.error("Error al crear la informaci√≥n del puesto:", error);
                showMessage(`Error al guardar la informaci√≥n del puesto: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
            }
        });

        // --- L√≥gica del Formulario de Edici√≥n de Puesto (Si el documento ya existe) ---
        editComercianteButton.addEventListener('click', () => {
            comercianteDetails.classList.add('hidden');
            editComercianteFormContainer.classList.remove('hidden');
        });

        cancelEditComercianteButton.addEventListener('click', () => {
            editComercianteFormContainer.classList.add('hidden');
            comercianteDetails.classList.remove('hidden');
        });

        comercianteEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessage("No est√°s autenticado para editar tu puesto.", 'error');
                return;
            }

            const updatedBusinessName = editBusinessName.value.trim();
            const updatedWhatsapp = editWhatsapp.value.trim();
            const updatedDescription = editDescription.value.trim();
            const updatedLogoUrl = editLogoUrl.value.trim();

            if (!updatedBusinessName) {
                showMessage("El nombre del negocio no puede estar vac√≠o.", 'error');
                return;
            }

            showMessage('Guardando cambios del puesto...', 'info');
            const submitButton = comercianteEditForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                const comercianteDocRef = doc(db, `artifacts/${appId}/users/${userId}/comerciantes`, userId);
                await updateDoc(comercianteDocRef, {
                    businessName: updatedBusinessName,
                    whatsapp: updatedWhatsapp,
                    description: updatedDescription,
                    logoUrl: updatedLogoUrl || 'https://placehold.co/150x150/cccccc/333333?text=Logo'
                });

                showMessage('Informaci√≥n del puesto actualizada con √©xito. üéâ', 'success');
                editComercianteFormContainer.classList.add('hidden');
                comercianteDetails.classList.remove('hidden');
            } catch (error) {
                console.error("Error al actualizar la informaci√≥n del puesto:", error);
                showMessage(`Error al actualizar el puesto: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
            }
        });

        // --- L√≥gica del Editor de Productos ---

        // Toggle del formulario de a√±adir producto
        toggleAddProductFormButton.addEventListener('click', () => {
            addProductFormContainer.classList.toggle('hidden');
            if (!addProductFormContainer.classList.contains('hidden')) {
                toggleAddProductFormButton.textContent = 'Ocultar Formulario';
            } else {
                toggleAddProductFormButton.textContent = 'A√±adir Nuevo Producto';
            }
        });

        // Manejo del env√≠o del formulario de producto
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessage('Debes iniciar sesi√≥n para a√±adir productos.', 'error');
                return;
            }

            const productName = productNameInput.value.trim();
            const productPrice = parseFloat(productPriceInput.value);
            const productImageUrl = productImageUrlInput.value.trim();
            const productDescription = productDescriptionInput.value.trim();

            if (!productName || isNaN(productPrice) || productPrice <= 0) {
                showMessage('Por favor, completa el nombre y un precio v√°lido para el producto.', 'error');
                return;
            }

            addProductLoadingSpinner.classList.remove('hidden');
            productForm.querySelector('button[type="submit"]').disabled = true;

            try {
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/productos`);
                
                await addDoc(productsCollectionRef, {
                    name: productName,
                    price: productPrice,
                    imageUrl: productImageUrl || 'https://placehold.co/400x250/cccccc/333333?text=Sin+Imagen',
                    description: productDescription,
                    createdAt: new Date(),
                    comercianteId: userId // Referencia al comerciante
                });

                showMessage('Producto a√±adido con √©xito. üéâ', 'success');
                productForm.reset();
                addProductFormContainer.classList.add('hidden');
                toggleAddProductFormButton.textContent = 'A√±adir Nuevo Producto';

            } catch (error) {
                console.error("Error al a√±adir el producto:", error);
                showMessage(`Error al a√±adir el producto: ${error.message}`, 'error');
            } finally {
                addProductLoadingSpinner.classList.add('hidden');
                productForm.querySelector('button[type="submit"]').disabled = false;
            }
        });

        // Funci√≥n para cargar y mostrar productos
        async function loadProducts(currentUserId) {
            if (!db || !currentUserId) {
                console.warn("Firestore o userId no disponibles para cargar productos.");
                return;
            }

            if (unsubscribeProducts) {
                unsubscribeProducts();
            }

            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/productos`);

            unsubscribeProducts = onSnapshot(productsCollectionRef, (snapshot) => {
                productsList.innerHTML = '';
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });

                if (products.length === 0) {
                    noProductsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.add('hidden');
                    products.forEach(product => {
                        const productCard = `
                            <div class="product-card">
                                <img src="${product.imageUrl}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/333333?text=Imagen+No+Disp.';">
                                <div class="product-card-content">
                                    <h4 class="product-card-title">${product.name}</h4>
                                    <p class="product-card-price">$${product.price.toFixed(2)}</p>
                                    <p class="product-card-description">${product.description || 'Sin descripci√≥n.'}</p>
                                    <button data-id="${product.id}" class="btn-cmyk btn-red w-full mt-4 text-sm delete-product-button" data-tooltip="Elimina este producto de tu cat√°logo">
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        `;
                        productsList.insertAdjacentHTML('beforeend', productCard);
                    });

                    document.querySelectorAll('.delete-product-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const productId = e.target.dataset.id;
                            confirmAndDeleteProduct(productId);
                        });
                    });
                }
            }, (error) => {
                console.error("Error al cargar productos en tiempo real:", error);
                showMessage(`Error al cargar tus productos: ${error.message}`, 'error');
            });
        }

        async function confirmAndDeleteProduct(productId) {
            // Placeholder: en un proyecto real, esto ser√≠a un modal personalizado
            const confirmation = confirm("¬øEst√°s seguro de que quieres eliminar este producto?");
            if (!confirmation) {
                return;
            }

            try {
                if (!userId) {
                    showMessage('Debes iniciar sesi√≥n para eliminar productos.', 'error');
                    return;
                }
                showMessage('Eliminando producto...', 'info');
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/productos`, productId);
                await deleteDoc(productDocRef);
                showMessage('Producto eliminado con √©xito.', 'success');
            } catch (error) {
                console.error("Error al eliminar producto:", error);
                showMessage(`Error al eliminar producto: ${error.message}`, 'error');
            }
        }

        // Event listener para el bot√≥n de cerrar sesi√≥n
        logoutButton.addEventListener('click', async () => {
            try {
                if (unsubscribeComercianteData) {
                    unsubscribeComercianteData(); 
                }
                if (unsubscribeProducts) {
                    unsubscribeProducts();
                }
                await signOut(auth);
                showMessage('Sesi√≥n cerrada. Redirigiendo...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html'; 
                }, 1500); // Redirige m√°s r√°pido
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
                showMessage(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            }
        });

        // Event listener para el bot√≥n de ir a la galer√≠a
        goToGalleryButton.addEventListener('click', () => {
            window.location.href = 'galeria-productos.html';
        });

        window.onload = initializeFirebase;
    </script>
</body>
</html>
