<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Comerciante - Feria Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .product-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        /* Estilos de botones 3D con CMYK */
        .btn-cmyk {
            @apply font-bold py-2 px-4 rounded-lg relative overflow-hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }
        .btn-cmyk::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            background: rgba(0,0,0,0.1); /* Sombra sutil para efecto 3D */
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.2s ease;
            z-index: -1;
        }
        .btn-cmyk:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-cmyk:hover::after {
            transform: scaleY(1);
        }
        .btn-cmyk:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        
        /* Colores específicos CMYK para botones */
        .btn-cyan { @apply bg-cyan-500 text-white; }
        .btn-magenta { @apply bg-fuchsia-600 text-white; }
        .btn-yellow { @apply bg-yellow-400 text-gray-800; }
        .btn-black { @apply bg-gray-800 text-white; }
        .btn-red { @apply bg-red-500 text-white; } /* Para cerrar sesión o eliminar */


        .message-box {
            @apply p-4 rounded-lg text-sm text-center font-medium;
        }
        .message-box.success { @apply bg-green-100 text-green-700; }
        .message-box.error { @apply bg-red-100 text-red-700; }
        .message-box.info { @apply bg-teal-100 text-teal-700; }

        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200;
        }

        /* Estilos para tooltips */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
            margin-bottom: 0.5rem;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0.25rem);
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 20;
        }
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Loader para botones */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">Mi Puesto Online</h1>
            <nav class="space-x-4">
                <button id="go-to-gallery-button" class="btn-cmyk btn-yellow" data-tooltip="Explora la galería pública de productos y puestos">
                    Ver la Galería
                </button>
                <button id="logout-button" class="btn-cmyk btn-red" data-tooltip="Cierra tu sesión actual">
                    Cerrar Sesión
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-6 md:p-10">
        <div id="loading-container" class="text-center py-20 text-xl font-semibold text-gray-500">
            Cargando...
        </div>

        <div id="content" class="hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6" id="business-name-display"></h2>
            
            <div id="message-container" class="mb-6 hidden"></div>

            <!-- Sección para la información del puesto del comerciante -->
            <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800 flex justify-between items-center">
                    Información de tu Puesto
                    <button id="edit-comerciante-button" class="btn-cmyk btn-yellow" data-tooltip="Modifica los detalles de tu negocio y la URL de tu logo">
                        Editar Información del Puesto
                    </button>
                </h3>
                
                <div id="comerciante-details" class="space-y-3">
                    <p><strong class="font-semibold">Nombre del Negocio:</strong> <span id="detail-business-name"></span></p>
                    <p><strong class="font-semibold">Correo Electrónico:</strong> <span id="detail-email"></span></p>
                    <p><strong class="font-semibold">WhatsApp:</strong> <span id="detail-whatsapp"></span></p>
                    <p><strong class="font-semibold">Descripción:</strong> <span id="detail-description" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Logo URL:</strong> <span id="detail-logo-url" class="block bg-gray-50 p-3 rounded-md mt-2 text-gray-600 italic"></span></p>
                    <p><strong class="font-semibold">Fecha de Registro:</strong> <span id="detail-registration-date"></span></p>
                </div>

                <!-- Formulario de Edición del Puesto (Inicialmente oculto) -->
                <div id="edit-comerciante-form-container" class="hidden mt-6 bg-gray-50 p-6 rounded-lg">
                    <h4 class="text-xl font-bold text-gray-700 mb-4">Editar Datos del Puesto</h4>
                    <form id="comerciante-edit-form" class="space-y-4">
                        <div>
                            <label for="editBusinessName" class="block text-sm font-medium text-gray-700">Nombre del Negocio</label>
                            <input type="text" id="editBusinessName" name="editBusinessName" class="input-field" required>
                        </div>
                        <div>
                            <label for="editEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input type="email" id="editEmail" name="editEmail" class="input-field" readonly disabled>
                            <p class="text-xs text-gray-500 mt-1">El correo electrónico no se puede cambiar aquí.</p>
                        </div>
                        <div>
                            <label for="editWhatsapp" class="block text-sm font-medium text-gray-700">Número de WhatsApp</label>
                            <input type="tel" id="editWhatsapp" name="editWhatsapp" class="input-field">
                        </div>
                        <div>
                            <label for="editDescription" class="block text-sm font-medium text-gray-700">Descripción del Negocio</label>
                            <textarea id="editDescription" name="editDescription" rows="3" class="input-field"></textarea>
                        </div>
                        <div>
                            <label for="editLogoUrl" class="block text-sm font-medium text-gray-700">URL del Logo de tu Puesto</label>
                            <input type="url" id="editLogoUrl" name="editLogoUrl" class="input-field">
                            <p class="text-xs text-gray-500 mt-1">Sube el logo de tu negocio a un servicio de hosting y pega la URL aquí.</p>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="cancel-edit-comerciante" class="btn-cmyk btn-black text-sm" data-tooltip="Descartar los cambios y volver a la vista de los datos del puesto">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-cmyk btn-cyan text-sm" data-tooltip="Guarda las modificaciones realizadas en la información de tu puesto">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Sección para añadir nuevo producto -->
            <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Añadir Nuevo Producto</h3>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="productName" name="productName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio</label>
                        <input type="number" id="productPrice" name="productPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" step="0.01" required>
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="productDescription" name="productDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                    </div>
                    <div>
                        <label for="productImage" class="block text-sm font-medium text-gray-700">Imagen (URL)</label>
                        <input type="url" id="productImage" name="productImage" placeholder="https://ejemplo.com/imagen.jpg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <button type="submit" class="btn-cmyk btn-magenta w-full" data-tooltip="Añade un nuevo producto a tu catálogo para que se muestre en la feria">
                        Añadir Nuevo Producto
                    </button>
                </form>
            </section>

            <!-- Sección de productos del comerciante -->
            <section>
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Tus Productos Publicados</h3>
                <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas de productos se inyectarán aquí -->
                </div>
                <div id="no-products-message" class="text-center py-10 text-gray-500 hidden">
                    <p>Aún no tienes productos publicados.</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Pie de página -->
    <footer class="bg-gray-800 text-white py-8 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 Feria Online. Todos los derechos reservados.</p>
            <p class="text-sm mt-2">
                <a href="#" class="hover:underline">Política de Privacidad</a> | 
                <a href="#" class="hover:underline">Términos de Servicio</a>
            </p>
        </div>
    </footer>

    <!-- Script de Firebase y lógica del panel -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { firebaseConfig, appId } from "./firebase-config.js";

        let app;
        let auth;
        let db;
        let userId = null;
        let businessName = null;
        let unsubscribeComercianteData = null;
        let unsubscribeProducts = null;

        const messageContainer = document.getElementById('message-container');
        const businessNameDisplay = document.getElementById('business-name-display');
        const loadingContainer = document.getElementById('loading-container');
        const contentContainer = document.getElementById('content');
        const comercianteDetails = document.getElementById('comerciante-details');
        const editComercianteButton = document.getElementById('edit-comerciante-button');
        const editComercianteFormContainer = document.getElementById('edit-comerciante-form-container');
        const comercianteEditForm = document.getElementById('comerciante-edit-form');

        const editBusinessName = document.getElementById('editBusinessName');
        const editEmail = document.getElementById('editEmail');
        const editWhatsapp = document.getElementById('editWhatsapp');
        const editDescription = document.getElementById('editDescription');
        const editLogoUrl = document.getElementById('editLogoUrl');
        const cancelEditComercianteButton = document.getElementById('cancel-edit-comerciante');

        const detailBusinessName = document.getElementById('detail-business-name');
        const detailEmail = document.getElementById('detail-email');
        const detailWhatsapp = document.getElementById('detail-whatsapp');
        const detailDescription = document.getElementById('detail-description');
        const detailLogoUrl = document.getElementById('detail-logo-url');
        const detailRegistrationDate = document.getElementById('detail-registration-date');

        const addProductForm = document.getElementById('add-product-form');
        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const productDescriptionInput = document.getElementById('productDescription');
        const productImageInput = document.getElementById('productImage');
        const productsContainer = document.getElementById('products-container');
        const noProductsMessage = document.getElementById('no-products-message');
        const logoutButton = document.getElementById('logout-button');
        const goToGalleryButton = document.getElementById('go-to-gallery-button');


        function showMessage(message, type = 'info') {
            messageContainer.innerHTML = message;
            messageContainer.className = `message-box ${type}`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado:", userId);
                        
                        setupComercianteDataListener(userId);
                        setupProductsListener(userId);
                        
                        loadingContainer.classList.add('hidden');
                        contentContainer.classList.remove('hidden');

                    } else {
                        console.log("Usuario no autenticado, redirigiendo a la página principal.");
                        window.location.href = 'index.html';
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o cargar el panel:", error);
                showMessage(`Error al iniciar la aplicación: ${error.message}`, 'error');
            }
        }

        function setupComercianteDataListener(uid) {
            if (unsubscribeComercianteData) {
                unsubscribeComercianteData(); 
            }
            const comercianteDocRef = doc(db, `artifacts/${appId}/users/${uid}/comerciantes`, uid);
            unsubscribeComercianteData = onSnapshot(comercianteDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    businessName = data.businessName;
                    businessNameDisplay.textContent = businessName;
                    detailBusinessName.textContent = data.businessName || "No definido";
                    detailEmail.textContent = data.email || "No definido";
                    detailWhatsapp.textContent = data.whatsapp || "No definido";
                    detailDescription.textContent = data.description || "Sin descripción.";
                    detailLogoUrl.textContent = data.logoUrl || "Sin URL de Logo";
                    
                    if (data.registrationDate && data.registrationDate.toDate) {
                        detailRegistrationDate.textContent = data.registrationDate.toDate().toLocaleDateString('es-ES');
                    } else {
                        detailRegistrationDate.textContent = "Fecha no disponible";
                    }

                    editBusinessName.value = data.businessName || '';
                    editEmail.value = data.email || '';
                    editWhatsapp.value = data.whatsapp || '';
                    editDescription.value = data.description || '';
                    editLogoUrl.value = data.logoUrl || '';

                    console.log("Datos del comerciante cargados/actualizados:", data);
                } else {
                    console.error("No se encontraron datos del comerciante para el usuario:", uid);
                    businessNameDisplay.textContent = 'Nombre del Negocio';
                    showMessage("No se encontró la información de tu puesto. Asegúrate de registrarte.", 'error');
                }
            }, (error) => {
                console.error("Error en el listener de datos del comerciante:", error);
                showMessage(`Error al cargar datos del negocio: ${error.message}`, 'error');
            });
        }

        function setupProductsListener(uid) {
            if (unsubscribeProducts) {
                unsubscribeProducts(); 
            }
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${uid}/productos`);
            unsubscribeProducts = onSnapshot(productsCollectionRef, (querySnapshot) => {
                productsContainer.innerHTML = ''; 

                if (querySnapshot.empty) {
                    noProductsMessage.classList.remove('hidden');
                    return;
                }
                
                noProductsMessage.classList.add('hidden');

                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    const cardHtml = `
                        <div class="bg-white rounded-lg product-card overflow-hidden">
                            <div class="h-48 overflow-hidden">
                                <img src="${product.imageUrl || 'https://placehold.co/400x250/cccccc/333333?text=Sin+Imagen'}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/333333?text=No+Disponible';">
                            </div>
                            <div class="p-4">
                                <h4 class="text-xl font-semibold text-gray-900">${product.name}</h4>
                                <p class="text-lg font-bold text-gray-800 mt-2">$${product.price ? product.price.toFixed(2) : '0.00'}</p>
                                <p class="text-sm text-gray-500 mt-1">${product.description || ''}</p>
                                <button data-id="${productId}" class="btn-cmyk btn-red w-full mt-4 text-sm" data-tooltip="Elimina este producto de tu catálogo">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                    productsContainer.innerHTML += cardHtml;
                });

                productsContainer.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', deleteProduct);
                });
            }, (error) => {
                console.error("Error en el listener de productos:", error);
                showMessage(`Error al cargar tus productos: ${error.message}`, 'error');
            });
        }
        
        async function deleteProduct(e) {
            const productId = e.target.dataset.id;
            if (!userId || !productId) {
                showMessage("No se pudo eliminar el producto. Faltan datos del usuario o del producto.", 'error');
                return;
            }

            if (!confirm("¿Estás seguro de que quieres eliminar este producto?")) {
                return;
            }

            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/productos`, productId);
                await deleteDoc(productDocRef);
                showMessage('Producto eliminado con éxito.', 'success');
            } catch (error) {
                console.error("Error al eliminar el producto:", error);
                showMessage(`Error al eliminar el producto: ${error.message}`, 'error');
            }
        }

        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                showMessage("Debes iniciar sesión para añadir productos.", 'error');
                return;
            }

            const productName = productNameInput.value;
            const productPrice = parseFloat(productPriceInput.value);
            const productDescription = productDescriptionInput.value;
            const productImage = productImageInput.value;

            try {
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/productos`);
                await addDoc(productsCollectionRef, {
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    imageUrl: productImage,
                    createdAt: new Date(),
                    comercianteId: userId,
                    businessName: businessName
                });

                showMessage('Producto añadido con éxito.', 'success');
                addProductForm.reset(); 

            } catch (error) {
                console.error("Error al añadir el producto:", error);
                showMessage(`Error al añadir el producto: ${error.message}`, 'error');
            }
        });

        editComercianteButton.addEventListener('click', () => {
            comercianteDetails.classList.add('hidden');
            editComercianteFormContainer.classList.remove('hidden');
        });

        cancelEditComercianteButton.addEventListener('click', () => {
            editComercianteFormContainer.classList.add('hidden');
            comercianteDetails.classList.remove('hidden');
        });

        comercianteEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                showMessage("No estás autenticado para editar tu puesto.", 'error');
                return;
            }

            const updatedBusinessName = editBusinessName.value;
            const updatedWhatsapp = editWhatsapp.value;
            const updatedDescription = editDescription.value;
            const updatedLogoUrl = editLogoUrl.value;

            try {
                showMessage('Guardando cambios del puesto...', 'info');
                const comercianteDocRef = doc(db, `artifacts/${appId}/users/${userId}/comerciantes`, userId);
                await updateDoc(comercianteDocRef, {
                    businessName: updatedBusinessName,
                    whatsapp: updatedWhatsapp,
                    description: updatedDescription,
                    logoUrl: updatedLogoUrl
                });

                showMessage('Información del puesto actualizada con éxito. 🎉', 'success');
                editComercianteFormContainer.classList.add('hidden');
                comercianteDetails.classList.remove('hidden');
            } catch (error) {
                console.error("Error al actualizar la información del puesto:", error);
                showMessage(`Error al actualizar el puesto: ${error.message}`, 'error');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                if (unsubscribeComercianteData) unsubscribeComercianteData();
                if (unsubscribeProducts) unsubscribeProducts();
                await signOut(auth);
                window.location.href = 'index.html'; // Redirigir al inicio después de cerrar sesión
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        });

        goToGalleryButton.addEventListener('click', () => {
            window.location.href = 'galeria-productos.html';
        });

        initializeFirebase();
    </script>
</body>
</html>
