<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería de Productos - Feria Online</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem 0;
        }
        .gallery-container {
            max-width: 1200px;
            width: 95%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            @apply bg-white rounded-lg p-8 md:p-10;
        }
        /* Estilo para las tarjetas de Puesto/Comerciante */
        .stall-card {
            @apply bg-white border border-gray-300 rounded-lg overflow-hidden shadow-md flex flex-col md:flex-row items-center p-6 mb-8;
            transition: transform 0.2s;
        }
        .stall-card:hover {
            transform: translateY(-5px);
        }
        .stall-card img {
            @apply w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-blue-200 shadow-md;
            flex-shrink: 0;
            margin-right: 1.5rem;
        }
        .stall-card-content {
            @apply flex-grow text-center md:text-left;
        }
        .stall-card-title {
            @apply text-2xl font-bold text-blue-800 mb-2;
        }
        .stall-card-description {
            @apply text-gray-700 text-sm;
        }

        /* Estilo para las tarjetas de Producto */
        .product-card {
            @apply bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm flex flex-col;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-card img {
            @apply w-full h-48 object-cover;
        }
        .product-card-content {
            @apply p-4 flex-grow;
        }
        .product-card-title {
            @apply text-lg font-semibold text-gray-900 mb-1;
        }
        .product-card-price {
            @apply text-xl font-bold text-green-600 mb-2;
        }
        .product-card-description {
            @apply text-gray-700 text-sm mb-2;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .product-card-comerciante {
            @apply text-xs text-gray-500 mt-auto pt-2 border-t border-gray-100;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos del modal/área de chat de IA */
        .ai-chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .ai-chat-box {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-md */
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb; /* gray-50 */
        }

        .ai-chat-message p {
            margin-bottom: 0.5rem;
        }
        .ai-chat-message strong {
            color: #1f2937; /* gray-900 */
        }

        .ai-chat-input-area {
            display: flex;
            gap: 0.5rem;
        }
        .ai-chat-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-md */
        }
        .ai-chat-button {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200;
        }
        .ai-chat-close-button {
            @apply bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors duration-200;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="gallery-container">
        <header class="text-center mb-8 pb-4 border-b border-gray-200 bg-blue-100 rounded-lg p-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-700 mb-4">
                Explora Nuestra Feria Online 🎨
            </h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto">
                Descubre productos únicos hechos con pasión por nuestros talentosos comerciantes.
            </p>
        </header>

        <div id="loading-message" class="text-center text-gray-500 mb-6">
            <span class="loader"></span> Cargando la feria...
        </div>

        <!-- Sección: Puestos de la Feria -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Nuestros Puestos</h2>
            <div id="stalls-grid" class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Las tarjetas de puestos se inyectarán aquí -->
            </div>
            <p id="no-stalls-found" class="text-center text-gray-500 mt-8 hidden">
                Aún no hay puestos registrados en la feria.
            </p>
        </section>

        <!-- Sección: Todos los Productos -->
        <section>
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Todos los Productos</h2>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de productos se inyectarán aquí -->
            </div>
            <p id="no-products-found" class="text-center text-gray-500 mt-8 hidden">
                Parece que aún no hay productos en la feria. ¡Vuelve pronto!
            </p>
        </section>


        <!-- CAMBIO AQUI: Pie de página con fondo azul MUY oscuro -->
        <footer class="text-center text-white text-sm mt-12 pt-8 border-t border-blue-800 bg-blue-900 py-4 rounded-b-lg">
            &copy; 2025 Feria Online. Todos los derechos reservados.
        </footer>
    </div>

    <!-- Overlay y Modal para el asistente de IA -->
    <div id="ai-chat-overlay" class="ai-chat-overlay hidden">
        <div class="ai-chat-box">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-xl font-bold text-gray-800">Preguntar al Experto sobre <span id="ai-product-name" class="text-blue-700"></span></h4>
                <button id="ai-chat-close" class="ai-chat-close-button">X</button>
            </div>
            <div id="ai-chat-messages" class="ai-chat-messages">
                <!-- Mensajes del chat irán aquí -->
            </div>
            <div class="ai-chat-input-area">
                <input type="text" id="ai-chat-question-input" class="ai-chat-input" placeholder="Haz tu pregunta...">
                <button id="ai-chat-send-button" class="ai-chat-button">
                    <span id="ai-chat-loading-spinner" class="loader hidden w-5 h-5 border-blue-200 border-t-white"></span>
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Script para Firebase y lógica de la galería -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, collectionGroup, getDocs, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Importamos la configuración de Firebase y el appId desde nuestro archivo local 'firebase-config.js'
        import { firebaseConfig, appId } from "./firebase-config.js";

        let app;
        let auth;
        let db;
        let unsubscribeProducts = null;
        let unsubscribeComerciantes = null;
        let currentProductData = null; // Para guardar el producto actual en el modal de IA

        // Elementos del DOM
        const productsGrid = document.getElementById('products-grid');
        const stallsGrid = document.getElementById('stalls-grid');
        const loadingMessage = document.getElementById('loading-message');
        const noProductsFoundMessage = document.getElementById('no-products-found');
        const noStallsFoundMessage = document.getElementById('no-stalls-found');

        // Elementos del chat de IA
        const aiChatOverlay = document.getElementById('ai-chat-overlay');
        const aiChatCloseButton = document.getElementById('ai-chat-close');
        const aiProductNameDisplay = document.getElementById('ai-product-name');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiChatQuestionInput = document.getElementById('ai-chat-question-input');
        const aiChatSendButton = document.getElementById('ai-chat-send-button');
        const aiChatLoadingSpinner = document.getElementById('ai-chat-loading-spinner');


        // Función de inicialización de Firebase
        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    await signInAnonymously(auth);
                    console.log("Sesión anónima iniciada para ver la galería.");
                    loadAllFairData(); 
                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                loadingMessage.textContent = `Error al cargar la feria: ${error.message}.`;
                loadingMessage.classList.add('text-red-700');
            }
        }

        // Función para cargar todos los datos de la feria (puestos y productos)
        async function loadAllFairData() {
            if (!db) {
                console.warn("Firestore no inicializado para cargar datos de la feria.");
                loadingMessage.textContent = 'Error: No se pudo conectar a la base de datos.';
                loadingMessage.classList.add('text-red-700');
                return;
            }

            loadingMessage.classList.remove('hidden');
            productsGrid.innerHTML = '';
            stallsGrid.innerHTML = '';
            noProductsFoundMessage.classList.add('hidden');
            noStallsFoundMessage.classList.add('hidden');

            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeComerciantes) unsubscribeComerciantes();

            // --- Cargar Puestos (Comerciantes) ---
            const comerciantesCollectionRef = collection(db, `artifacts/${appId}/users`);
            unsubscribeComerciantes = onSnapshot(comerciantesCollectionRef, async (usersSnapshot) => {
                const fetchedStalls = [];
                for (const userDoc of usersSnapshot.docs) {
                    const comercianteDocRef = doc(db, `artifacts/${appId}/users/${userDoc.id}/comerciantes`, userDoc.id);
                    const comercianteSnap = await getDoc(comercianteDocRef);
                    if (comercianteSnap.exists()) {
                        fetchedStalls.push({ id: comercianteSnap.id, ...comercianteSnap.data() });
                    }
                }

                stallsGrid.innerHTML = '';
                if (fetchedStalls.length === 0) {
                    noStallsFoundMessage.classList.remove('hidden');
                } else {
                    noStallsFoundMessage.classList.add('hidden');
                    fetchedStalls.forEach(stall => {
                        const stallCardHtml = `
                            <div class="stall-card">
                                <img src="${stall.logoUrl || 'https://placehold.co/150x150/cccccc/333333?text=Logo'}" alt="${stall.businessName || 'Puesto'}" class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-blue-200 shadow-md">
                                <div class="stall-card-content">
                                    <h3 class="stall-card-title">${stall.businessName || 'Puesto Sin Nombre'}</h3>
                                    <p class="stall-card-description">${stall.description || 'Este puesto no tiene una descripción.'}</p>
                                </div>
                            </div>
                        `;
                        stallsGrid.insertAdjacentHTML('beforeend', stallCardHtml);
                    });
                }
            }, (error) => {
                console.error("Error al cargar puestos en tiempo real:", error);
                noStallsFoundMessage.textContent = `Error al cargar los puestos: ${error.message}`;
                noStallsFoundMessage.classList.remove('hidden');
            });

            // --- Cargar Productos (desde collectionGroup) ---
            const productsQuery = collectionGroup(db, 'productos');
            unsubscribeProducts = onSnapshot(productsQuery, async (productsSnapshot) => {
                const fetchedProducts = [];
                const comercianteNamesMap = new Map();

                productsSnapshot.forEach(doc => {
                    fetchedProducts.push({ id: doc.id, ...doc.data() });
                });

                const uniqueComercianteIds = new Set(fetchedProducts.map(p => p.comercianteId).filter(Boolean));
                const fetchPromises = Array.from(uniqueComercianteIds).map(async (comercianteId) => {
                    if (!comercianteNamesMap.has(comercianteId)) {
                        const comercianteDocRef = doc(db, `artifacts/${appId}/users/${comercianteId}/comerciantes`, comercianteId);
                        const comercianteSnap = await getDoc(comercianteDocRef);
                        if (comercianteSnap.exists()) {
                            comercianteNamesMap.set(comercianteId, comercianteSnap.data().businessName || "Comerciante Desconocido");
                        } else {
                            comercianteNamesMap.set(comercianteId, "Comerciante Desconocido");
                        }
                    }
                });
                await Promise.all(fetchPromises);


                productsGrid.innerHTML = '';
                loadingMessage.classList.add('hidden');

                if (fetchedProducts.length === 0) {
                    noProductsFoundMessage.classList.remove('hidden');
                } else {
                    noProductsFoundMessage.classList.add('hidden');
                    fetchedProducts.forEach(product => {
                        const comercianteName = comercianteNamesMap.get(product.comercianteId) || product.businessName || "Comerciante Desconocido";
                        const productCard = `
                            <div class="product-card">
                                <img src="${product.imageUrl || 'https://placehold.co/400x250/cccccc/333333?text=Sin+Imagen'}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/333333?text=No+Disponible';">
                                <div class="p-4">
                                    <h4 class="product-card-title">${product.name}</h4>
                                    <p class="product-card-price">$${product.price ? product.price.toFixed(2) : '0.00'}</p>
                                    <p class="product-card-description">${product.description || 'Sin descripción.'}</p>
                                    <p class="product-card-comerciante">Vendido por: <strong>${comercianteName}</strong></p>
                                    <button class="ask-ai-button bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md mt-3 w-full" data-product='${JSON.stringify(product)}'>
                                        Preguntar al Experto ✨
                                    </button>
                                </div>
                            </div>
                        `;
                        productsGrid.insertAdjacentHTML('beforeend', productCard);
                    });

                    // Añadir listeners a los nuevos botones de IA
                    document.querySelectorAll('.ask-ai-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const productData = JSON.parse(event.target.dataset.product);
                            openAIChat(productData);
                        });
                    });
                }
            }, (error) => {
                console.error("Error al cargar productos de la galería en tiempo real:", error);
                loadingMessage.textContent = `Error al cargar los productos: ${error.message}`;
                loadingMessage.classList.add('text-red-700');
            });
        }

        // --- Lógica del Asistente de IA (Gemini API) ---
        aiChatCloseButton.addEventListener('click', () => {
            aiChatOverlay.classList.add('hidden');
            aiChatMessages.innerHTML = ''; // Limpiar mensajes al cerrar
            aiChatQuestionInput.value = ''; // Limpiar input al cerrar
            currentProductData = null;
        });

        aiChatSendButton.addEventListener('click', () => {
            const question = aiChatQuestionInput.value.trim();
            if (question && currentProductData) {
                sendQuestionToAI(currentProductData, question);
                aiChatQuestionInput.value = ''; // Limpiar input
            }
        });

        aiChatQuestionInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                aiChatSendButton.click();
            }
        });

        function openAIChat(productData) {
            currentProductData = productData;
            aiProductNameDisplay.textContent = productData.name;
            aiChatMessages.innerHTML = `
                <div class="ai-chat-message">
                    <p><strong>Asistente:</strong> ¡Hola! Soy tu experto en productos. Pregúntame lo que quieras sobre <strong>${productData.name}</strong>.</p>
                    <p class="text-xs text-gray-500 mt-1">Precio: $${productData.price.toFixed(2)}</p>
                    <p class="text-xs text-gray-500">Descripción: ${productData.description || 'Sin descripción.'}</p>
                </div>
            `;
            aiChatOverlay.classList.remove('hidden');
        }

        async function sendQuestionToAI(product, question) {
            addMessageToChat('user', question);
            aiChatLoadingSpinner.classList.remove('hidden');
            aiChatSendButton.disabled = true;

            const prompt = `Como asistente experto en productos de feria, responde la siguiente pregunta sobre el producto "${product.name}" (Descripción: "${product.description}", Precio: ${product.price}):\n\nPregunta: "${question}"\n\nRespuesta detallada y útil:`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // La clave se inyecta en tiempo de ejecución por el entorno

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                // Implementación de reintentos con backoff exponencial
                let response;
                let delay = 1000; // 1 segundo
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Salir del bucle si la respuesta es exitosa
                    } else if (response.status === 429) { // Demasiadas solicitudes (Too Many Requests)
                        console.warn(`Intento ${i + 1}/${maxRetries}: Demasiadas solicitudes. Reintentando en ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Duplicar el retraso
                    } else {
                        // Para otros errores que no sean 429, no reintentar
                        const errorData = await response.json();
                        console.error("Error de la API de Gemini (sin reintento):", errorData);
                        throw new Error(`Error ${response.status}: ${errorData.error?.message || 'Error desconocido de la API.'}`);
                    }
                }

                if (!response.ok) {
                    throw new Error("La API de Gemini no respondió correctamente después de varios reintentos.");
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    addMessageToChat('ai', text);
                } else {
                    addMessageToChat('ai', 'Lo siento, no pude generar una respuesta. Por favor, intenta de nuevo con una pregunta diferente.');
                    console.error("Respuesta inesperada de Gemini API:", result);
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                addMessageToChat('ai', `Lo siento, hubo un error: ${error.message}. Por favor, inténtalo más tarde.`);
            } finally {
                aiChatLoadingSpinner.classList.add('hidden');
                aiChatSendButton.disabled = false;
            }
        }

        function addMessageToChat(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('ai-chat-message', sender === 'user' ? 'text-right' : 'text-left');
            messageDiv.innerHTML = `<p><strong>${sender === 'user' ? 'Tú' : 'Asistente'}:</strong> ${text}</p>`;
            aiChatMessages.appendChild(messageDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight; // Auto-scroll
        }
        // --- Fin Lógica Asistente de IA ---

        window.onload = initializeFirebase;
    </script>
</body>
</html>
